server {
    listen 80;
    server_name foodgram.localhost localhost;
    client_max_body_size 10M; # Максимальный размер тела запроса (для загрузки файлов)

    # Раздача медиафайлов Django
    location /media/ {
        alias /usr/share/nginx/html/media/; # Путь, куда монтируется backend_media_volume в nginx
        expires 30d; # Кеширование медиафайлов
        add_header Cache-Control "public";
    }

    # Раздача статики Django (админка и т.д.), если она собирается и доступна Nginx
    # Если Джанго-админка работает напрямую через Gunicorn (как в ТЗ), этот блок не нужен,
    # и запросы /static/ (для админки) должны идти на бэкенд.
    # location /static_django/ {
    #     alias /usr/share/nginx/html/static_django/;
    #     expires 30d;
    #     add_header Cache-Control "public";
    # }

    # Проксирование запросов к API бэкенда
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend:8000/api/; # Обращение к backend сервису на порт 8000
        proxy_redirect off;
    }

    # Проксирование запросов к админке Django (если она работает через Gunicorn)
    # Это включает и статику админки, если она раздается Django (DEBUG=True) или Whitenoise
    location /admin/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend:8000/admin/;
        proxy_redirect off;
    }

    # Если статика админки должна раздаваться Django, а не собираться отдельно для Nginx:
    location /static/ { # Этот блок для статики Django, если она не собирается отдельно для nginx
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend:8000/static/;
        proxy_redirect off;
    }


    # Документация API (Redoc/Swagger)
    location /api/docs/ {
        root /usr/share/nginx/html/api/docs/;
        try_files $uri $uri/redoc.html; # Показываем redoc.html, если конкретный файл не найден
    }

    # Раздача статики фронтенда
    location / {
        root /usr/share/nginx/html/static_frontend/; # Путь, куда монтируется frontend_static_volume
        index index.html;
        try_files $uri /index.html; # Для SPA (Single Page Application)
        # Если $uri не найден как файл, отдать /index.html
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html/; # Можно создать кастомную страницу ошибок
    }
}